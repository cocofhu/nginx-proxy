<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>头部路由测试</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .test-button { background: #007bff; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        .test-button:hover { background: #0056b3; }
        .result { margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <h1>HTTP头部路由测试页面</h1>
    
    <div class="test-section">
        <h3>测试场景1: API版本路由</h3>
        <p>测试基于 X-API-Version 头部的路由</p>
        <button class="test-button" onclick="testApiVersion('v1')">测试 API v1</button>
        <button class="test-button" onclick="testApiVersion('v2')">测试 API v2</button>
        <button class="test-button" onclick="testApiVersion('')">测试默认路由</button>
        <div id="api-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h3>测试场景2: 客户端类型路由</h3>
        <p>测试基于 User-Agent 头部的路由</p>
        <button class="test-button" onclick="testUserAgent('Mobile')">测试移动端</button>
        <button class="test-button" onclick="testUserAgent('Desktop')">测试桌面端</button>
        <button class="test-button" onclick="testUserAgent('')">测试默认</button>
        <div id="client-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h3>测试场景3: 混合条件路由</h3>
        <p>测试IP + 头部的混合条件路由</p>
        <button class="test-button" onclick="testMixed('internal', 'true')">测试内部访问</button>
        <button class="test-button" onclick="testMixed('external', 'false')">测试外部访问</button>
        <div id="mixed-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h3>创建测试规则</h3>
        <p>点击下面的按钮创建测试用的代理规则</p>
        <button class="test-button" onclick="createTestRules()">创建测试规则</button>
        <div id="create-result" class="result"></div>
    </div>

    <script>
        const API_BASE = '/api';
        
        async function testApiVersion(version) {
            const resultDiv = document.getElementById('api-result');
            resultDiv.innerHTML = '测试中...';
            
            try {
                const headers = {};
                if (version) {
                    headers['X-API-Version'] = version;
                }
                
                const response = await fetch('/test-api', { headers });
                const result = await response.text();
                
                resultDiv.innerHTML = `
                    <strong>请求头部:</strong> ${version ? `X-API-Version: ${version}` : '无特殊头部'}<br>
                    <strong>响应:</strong> ${result}<br>
                    <strong>状态:</strong> ${response.status}
                `;
                resultDiv.className = 'result success';
            } catch (error) {
                resultDiv.innerHTML = `<strong>错误:</strong> ${error.message}`;
                resultDiv.className = 'result error';
            }
        }
        
        async function testUserAgent(userAgent) {
            const resultDiv = document.getElementById('client-result');
            resultDiv.innerHTML = '测试中...';
            
            try {
                const headers = {};
                if (userAgent) {
                    headers['User-Agent'] = userAgent;
                }
                
                const response = await fetch('/test-client', { headers });
                const result = await response.text();
                
                resultDiv.innerHTML = `
                    <strong>请求头部:</strong> ${userAgent ? `User-Agent: ${userAgent}` : '默认User-Agent'}<br>
                    <strong>响应:</strong> ${result}<br>
                    <strong>状态:</strong> ${response.status}
                `;
                resultDiv.className = 'result success';
            } catch (error) {
                resultDiv.innerHTML = `<strong>错误:</strong> ${error.message}`;
                resultDiv.className = 'result error';
            }
        }
        
        async function testMixed(type, internal) {
            const resultDiv = document.getElementById('mixed-result');
            resultDiv.innerHTML = '测试中...';
            
            try {
                const headers = {
                    'X-Access-Type': type,
                    'X-Internal': internal
                };
                
                const response = await fetch('/test-mixed', { headers });
                const result = await response.text();
                
                resultDiv.innerHTML = `
                    <strong>请求头部:</strong> X-Access-Type: ${type}, X-Internal: ${internal}<br>
                    <strong>响应:</strong> ${result}<br>
                    <strong>状态:</strong> ${response.status}
                `;
                resultDiv.className = 'result success';
            } catch (error) {
                resultDiv.innerHTML = `<strong>错误:</strong> ${error.message}`;
                resultDiv.className = 'result error';
            }
        }
        
        async function createTestRules() {
            const resultDiv = document.getElementById('create-result');
            resultDiv.innerHTML = '创建中...';
            
            const testRules = [
                {
                    server_name: 'api-test.local',
                    listen_ports: [80],
                    locations: [{
                        path: '/api',
                        upstreams: [
                            {
                                condition_ip: '',
                                target: 'http://api-v1.backend:8080',
                                headers: { 'X-API-Version': 'v1' }
                            },
                            {
                                condition_ip: '',
                                target: 'http://api-v2.backend:8080',
                                headers: { 'X-API-Version': 'v2' }
                            },
                            {
                                condition_ip: '',
                                target: 'http://api-default.backend:8080'
                            }
                        ]
                    }]
                },
                {
                    server_name: 'client-test.local',
                    listen_ports: [80],
                    locations: [{
                        path: '/',
                        upstreams: [
                            {
                                condition_ip: '',
                                target: 'http://mobile.backend:8080',
                                headers: { 'User-Agent': 'Mobile' }
                            },
                            {
                                condition_ip: '',
                                target: 'http://web.backend:8080'
                            }
                        ]
                    }]
                }
            ];
            
            try {
                let created = 0;
                for (const rule of testRules) {
                    const response = await fetch(`${API_BASE}/rules`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(rule)
                    });
                    
                    if (response.ok) {
                        created++;
                    }
                }
                
                resultDiv.innerHTML = `成功创建 ${created} 个测试规则`;
                resultDiv.className = 'result success';
            } catch (error) {
                resultDiv.innerHTML = `<strong>错误:</strong> ${error.message}`;
                resultDiv.className = 'result error';
            }
        }
    </script>
</body>
</html>