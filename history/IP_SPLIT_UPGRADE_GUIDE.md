# IP åˆ†æµåŠŸèƒ½å‡çº§æŒ‡å—

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°

æœ¬æ¬¡å‡çº§ä¸º nginx-proxy æ·»åŠ äº†æ™ºèƒ½ IP åˆ†æµåŠŸèƒ½ï¼Œæ”¯æŒï¼š

- âœ… å•ä¸ª IP ç²¾ç¡®åŒ¹é…ï¼ˆ`192.168.2.45` æˆ– `192.168.2.45/32`ï¼‰
- âœ… IP æ®µåŒ¹é…ï¼ˆ`192.168.1.0/24`ã€`10.0.0.0/16`ã€`172.16.0.0/8`ï¼‰
- âœ… è‡ªåŠ¨ä¼˜åŒ–åŒ¹é…æ€§èƒ½ï¼ˆå•ä¸ª IP ä½¿ç”¨ç²¾ç¡®åŒ¹é…ï¼ŒIP æ®µä½¿ç”¨æ­£åˆ™åŒ¹é…ï¼‰
- âœ… å‘åå…¼å®¹ç°æœ‰é…ç½®

## ğŸ”§ å‡çº§æ­¥éª¤

### 1. å¤‡ä»½ç°æœ‰é…ç½®
```bash
cp -r /etc/nginx/conf.d /etc/nginx/conf.d.backup
```

### 2. é‡æ–°ç¼–è¯‘é¡¹ç›®
```bash
go build -o bin/nginx-proxy cmd/server/main.go
```

### 3. é‡å¯æœåŠ¡
```bash
systemctl restart nginx-proxy
```

### 4. æµ‹è¯•æ–°åŠŸèƒ½
```bash
# ä½¿ç”¨æä¾›çš„ç¤ºä¾‹é…ç½®æµ‹è¯•
curl -X POST http://localhost:8080/api/rules \
  -H "Content-Type: application/json" \
  -d @examples/single-ip-rule.json

# é‡è½½ Nginx é…ç½®
curl -X POST http://localhost:8080/api/reload

# æ£€æŸ¥ç”Ÿæˆçš„é…ç½®
cat /etc/nginx/conf.d/*.conf
```

## ğŸ“‹ é…ç½®ç¤ºä¾‹

### ä¿®å¤æ‚¨å½“å‰çš„é—®é¢˜

**åŸé—®é¢˜é…ç½®**ï¼š
```json
{
  "condition_ip": "192.168.2.45/32",
  "target": "http://git.service.arpa"
}
```

**ç”Ÿæˆçš„ Nginx é…ç½®**ï¼ˆä¿®å¤åï¼‰ï¼š
```nginx
# æ£€æŸ¥ IP æ¡ä»¶: 192.168.2.45/32
if ($remote_addr = "192.168.2.45") {
    set $backend "http://git.service.arpa";
}
```

### æ”¯æŒçš„ IP æ ¼å¼

| è¾“å…¥æ ¼å¼ | ç”Ÿæˆçš„ Nginx æ¡ä»¶ | è¯´æ˜ |
|---------|------------------|------|
| `192.168.2.45/32` | `if ($remote_addr = "192.168.2.45")` | å•ä¸ª IPï¼Œç²¾ç¡®åŒ¹é… |
| `192.168.2.45` | `if ($remote_addr = "192.168.2.45")` | å•ä¸ª IPï¼Œç²¾ç¡®åŒ¹é… |
| `192.168.1.0/24` | `if ($remote_addr ~ "^192\.168\.1\.\d+$")` | Cç±»å­ç½‘ |
| `10.0.0.0/16` | `if ($remote_addr ~ "^10\.0\.\d+\.\d+$")` | Bç±»å­ç½‘ |
| `172.16.0.0/8` | `if ($remote_addr ~ "^172\.\d+\.\d+\.\d+$")` | Aç±»å­ç½‘ |
| `0.0.0.0/0` | `if ($backend = "")` | é»˜è®¤è·¯ç”± |

## ğŸ§ª æµ‹è¯•éªŒè¯

### 1. åˆ›å»ºæµ‹è¯•è§„åˆ™
```bash
# æµ‹è¯•å•ä¸ª IP åˆ†æµ
curl -X POST http://localhost:8080/api/rules \
  -H "Content-Type: application/json" \
  -d '{
    "server_name": "test.example.com",
    "listen_ports": [80],
    "locations": [{
      "path": "/",
      "upstreams": [
        {
          "condition_ip": "192.168.2.45/32",
          "target": "http://git.service.arpa"
        },
        {
          "condition_ip": "0.0.0.0/0",
          "target": "http://192.168.2.1"
        }
      ]
    }]
  }'
```

### 2. éªŒè¯ç”Ÿæˆçš„é…ç½®
```bash
# æŸ¥çœ‹ç”Ÿæˆçš„é…ç½®æ–‡ä»¶
ls /etc/nginx/conf.d/
cat /etc/nginx/conf.d/*.conf

# æµ‹è¯• Nginx é…ç½®è¯­æ³•
nginx -t
```

### 3. é‡è½½å¹¶æµ‹è¯•
```bash
# é‡è½½ Nginx
curl -X POST http://localhost:8080/api/reload

# æµ‹è¯•åˆ†æµæ•ˆæœ
curl -H "Host: test.example.com" http://your-server/
```

## ğŸ” æ•…éšœæ’é™¤

### é—®é¢˜ 1ï¼šé…ç½®ä¸ç”Ÿæ•ˆ
**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥ Nginx é…ç½®è¯­æ³•ï¼š`nginx -t`
2. æŸ¥çœ‹é”™è¯¯æ—¥å¿—ï¼š`tail -f /var/log/nginx/error.log`
3. ç¡®è®¤é…ç½®å·²é‡è½½ï¼š`curl -X POST http://localhost:8080/api/reload`

### é—®é¢˜ 2ï¼šIP åŒ¹é…ä¸æ­£ç¡®
**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥ç”Ÿæˆçš„é…ç½®æ–‡ä»¶ä¸­çš„ IP æ¡ä»¶
2. ç¡®è®¤å®¢æˆ·ç«¯ IP æ˜¯å¦æ­£ç¡®ï¼ˆæ³¨æ„ä»£ç†å’Œè´Ÿè½½å‡è¡¡å™¨çš„å½±å“ï¼‰
3. æŸ¥çœ‹è®¿é—®æ—¥å¿—ç¡®è®¤ `$remote_addr` çš„å€¼

### é—®é¢˜ 3ï¼šæ€§èƒ½é—®é¢˜
**è§£å†³æ–¹æ¡ˆ**ï¼š
1. å•ä¸ª IP ä¼šè‡ªåŠ¨ä½¿ç”¨ç²¾ç¡®åŒ¹é…ï¼ˆæ€§èƒ½æœ€ä½³ï¼‰
2. é¿å…è¿‡å¤šçš„åˆ†æµè§„åˆ™
3. å°†æ›´å…·ä½“çš„è§„åˆ™æ”¾åœ¨å‰é¢

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

æ–°çš„æ™ºèƒ½åŒ¹é…ç³»ç»Ÿä¼šæ ¹æ® IP æ ¼å¼è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜çš„åŒ¹é…æ–¹å¼ï¼š

- **ç²¾ç¡®åŒ¹é…**ï¼šå•ä¸ª IP ä½¿ç”¨ `=` æ“ä½œç¬¦ï¼Œæ€§èƒ½æœ€ä½³
- **æ­£åˆ™åŒ¹é…**ï¼šIP æ®µä½¿ç”¨ä¼˜åŒ–çš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œå¹³è¡¡æ€§èƒ½å’ŒåŠŸèƒ½
- **è§„åˆ™é¡ºåº**ï¼šæ›´å…·ä½“çš„è§„åˆ™è‡ªåŠ¨ä¼˜å…ˆåŒ¹é…

## ğŸ”„ å›æ»šæ–¹æ¡ˆ

å¦‚æœé‡åˆ°é—®é¢˜éœ€è¦å›æ»šï¼š

1. æ¢å¤å¤‡ä»½çš„é…ç½®ï¼š
```bash
rm -rf /etc/nginx/conf.d
mv /etc/nginx/conf.d.backup /etc/nginx/conf.d
```

2. é‡å¯ Nginxï¼š
```bash
systemctl restart nginx
```

3. ä½¿ç”¨æ—§ç‰ˆæœ¬çš„äºŒè¿›åˆ¶æ–‡ä»¶

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·æä¾›ï¼š
1. é”™è¯¯æ—¥å¿—ï¼š`/var/log/nginx/error.log`
2. ç”Ÿæˆçš„é…ç½®æ–‡ä»¶å†…å®¹
3. å…·ä½“çš„ IP åˆ†æµéœ€æ±‚
4. æµ‹è¯•æ­¥éª¤å’Œé¢„æœŸç»“æœ